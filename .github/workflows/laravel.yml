name: Laravel CI

on: [push]

jobs:
  laravel-test:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Ya tienes PHP 8.4 instalado en el servidor, no necesitas setup-php
      - name: Verify PHP
        run: php -v

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'   # versi√≥n estable soportada
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm ci

      - name: Install PHP Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Build Assets
        run: npm run build

      - name: Run Tests
        id: test
        run: ./vendor/bin/phpunit

      - name: Deploy
        if: steps.test.outcome == 'success'
        run: |
          echo "Deploying application..."
          ls

      - name: Artifact
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: artifacts
          path: composer.json